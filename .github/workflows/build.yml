name: Build and Publish Headpose

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      VERSION: "1.0.0"
      PKG_NAME: headpose
      KEYRING_PKG_NAME: headpose-keyring
      REPO_ARCHIVE: root-repo.tar.gz

    steps:

      # Checkout source
      - name: Checkout source
        uses: actions/checkout@v4

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      # Build Nuitka binary
      - name: Build Nuitka binary
        run: |
          mkdir -p build

          nuitka \
            --onefile \
            --follow-imports \
            --lto=no \
            --python-flag=no_docstrings \
            --static-libpython=no \
            --include-data-dir=src/weights=weights \
            --output-dir=build \
            --output-filename=headpose \
            src/main.py

          chmod 755 build/headpose
          file build/headpose

      # Build binary DEB package
      - name: Build headpose DEB package
        run: |
          PKG_DIR=${PKG_NAME}_${VERSION}_amd64

          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin

          cp build/headpose ${PKG_DIR}/usr/bin/headpose
          chmod 755 ${PKG_DIR}/usr/bin/headpose

          cat > ${PKG_DIR}/DEBIAN/control <<EOF
          Package: headpose
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Sayantan Dey <iamsayantandey007@gmail.com>
          Description: Head Pose Estimation Tool
          Head pose estimation using SCRFD + Pose Estimator.
          EOF

          dpkg-deb --build ${PKG_DIR}

      # Build headpose-keyring DEB package
      - name: Build keyring DEB package
        run: |
          KEYRING_DIR=${KEYRING_PKG_NAME}_${VERSION}_all
          mkdir -p ${KEYRING_DIR}/DEBIAN
          mkdir -p ${KEYRING_DIR}/etc/apt/sources.list.d
          mkdir -p ${KEYRING_DIR}/etc/apt/preferences.d
          mkdir -p ${KEYRING_DIR}/usr/share/keyrings

          # Control file
          cat > ${KEYRING_DIR}/DEBIAN/control <<EOF
          Package: headpose-keyring
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: all
          Maintainer: Sayantan Dey <iamsayantandey007@gmail.com>
          Description: Headpose APT keyring
          Contains the GPG key to verify headpose packages.
          EOF

          # Sources list
          echo "deb [signed-by=/usr/share/keyrings/headpose-repo-keyring.gpg] http://172.14.3.41:8000 stable main" \
            > ${KEYRING_DIR}/etc/apt/sources.list.d/headpose-ubuntu2404-x86_64.list

          # Pin file
          echo -e "Package: headpose\nPin: release o=HeadPose\nPin-Priority: 600" \
            > ${KEYRING_DIR}/etc/apt/preferences.d/headpose-repository-pin-600

          # Convert public key ASCII to .gpg (public key stored in repo, not secret)
          gpg --dearmor < keys/public.asc > ${KEYRING_DIR}/usr/share/keyrings/headpose-repo-keyring.gpg

          dpkg-deb --build ${KEYRING_DIR}

      # Install repo tools
      - name: Install APT repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg

      # Import private key from GitHub Secrets
      - name: Import GPG private key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      # Prepare repository folder
      - name: Prepare repository folder
        run: |
          mkdir -p root-repo/pool/main/h/headpose
          mkdir -p root-repo/dists/stable/main/binary-amd64

      # Add packages to pool
      - name: Add packages to pool
        run: |
          mv headpose_${VERSION}_amd64.deb root-repo/pool/main/h/headpose/

      # Generate Packages + Release
      - name: Generate APT metadata
        run: |
          cd root-repo
          dpkg-scanpackages -m pool > dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-amd64/Packages

          apt-ftparchive release dists/stable > dists/stable/Release
          sed -i '1iOrigin: HeadPose\nLabel: HeadPose' dists/stable/Release
          cd ..

      # Sign Release + InRelease using private key
      - name: Sign Release
        run: |
          cd root-repo
          gpg --batch --yes --pinentry-mode loopback \
              --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
              --clearsign -o dists/stable/InRelease dists/stable/Release

          gpg --batch --yes --pinentry-mode loopback \
              --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
              -abs -o dists/stable/Release.gpg dists/stable/Release
          cd ..

      # Archive ENTIRE repo
      - name: Archive APT repository
        run: |
          tar -czf $REPO_ARCHIVE root-repo
          ls -lh $REPO_ARCHIVE

      # Upload GitHub Pages artifact
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: root-repo

      # Publish GitHub Release
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Headpose v${{ env.VERSION }}
          files: |
            build/headpose
            ${{ env.REPO_ARCHIVE }}
            headpose-keyring_${{ env.VERSION }}_all.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
