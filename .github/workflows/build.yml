name: Build and Publish Headpose

on:
  push:
    branches:
      - main  
  workflow_dispatch: {} 

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      VERSION: "1.0.0"  
      PKG_NAME: headpose

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: Build Nuitka binary
        run: |
          mkdir -p build

          nuitka \
            --onefile \
            --follow-imports \
            --lto=no \
            --python-flag=no_docstrings \
            --static-libpython=no \
            --include-data-dir=src/weights=weights \
            --output-dir=build \
            --output-filename=headpose \
            src/main.py

          chmod 755 build/headpose
          file build/headpose

      - name: Build DEB package
        run: |
          PKG_DIR=${PKG_NAME}_${VERSION}_amd64

          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin

          cp build/headpose ${PKG_DIR}/usr/bin/headpose
          chmod 755 ${PKG_DIR}/usr/bin/headpose

          cat > ${PKG_DIR}/DEBIAN/control <<EOF
          Package: headpose
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Sayantan Dey <iamsayantandey007@gmail.com>
          Description: Head Pose Estimation Tool
           Head pose estimation using SCRFD + Pose Estimator.
          EOF

          dpkg-deb --build ${PKG_DIR}

      - name: Verify artifacts
        run: |
          ls -lh
          ls -lh build
          ls -lh *.deb

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Headpose v${{ env.VERSION }}
          files: |
            build/headpose
            headpose_${{ env.VERSION }}_amd64.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
