name: Build and Publish Headpose

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      VERSION: "1.0.0"
      PKG_NAME: headpose
      REPO_ARCHIVE: root-repo.tar.gz

    steps:

      # ✅ Checkout
      - name: Checkout source
        uses: actions/checkout@v4


      # ✅ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"


      # ✅ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka


      # ✅ Build Binary
      - name: Build Nuitka binary
        run: |
          mkdir -p build

          nuitka \
            --onefile \
            --follow-imports \
            --lto=no \
            --python-flag=no_docstrings \
            --static-libpython=no \
            --include-data-dir=src/weights=weights \
            --output-dir=build \
            --output-filename=headpose \
            src/main.py

          chmod 755 build/headpose
          file build/headpose


      # ✅ Build DEB
      - name: Build DEB package
        run: |
          PKG_DIR=${PKG_NAME}_${VERSION}_amd64

          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin

          cp build/headpose ${PKG_DIR}/usr/bin/headpose
          chmod 755 ${PKG_DIR}/usr/bin/headpose

          cat > ${PKG_DIR}/DEBIAN/control <<EOF
          Package: headpose
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Sayantan Dey <iamsayantandey007@gmail.com>
          Description: Head Pose Estimation Tool
           Head pose estimation using SCRFD + Pose Estimator.
          EOF

          dpkg-deb --build ${PKG_DIR}

      # ✅ Install repo tools
      - name: Install APT repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils

      # ✅ Create repo if first run
      - name: Prepare repository folder
        run: |
          if [ ! -d root-repo ]; then
            mkdir root-repo
          fi

          mkdir -p root-repo/pool/main/h/headpose
          mkdir -p root-repo/dists/stable/main/binary-amd64


      # ✅ Move new package into pool
      - name: Add package to pool
        run: |
          mv headpose_${VERSION}_amd64.deb root-repo/pool/main/h/headpose/


      # ✅ Generate Packages + Release (NO GPG)
      - name: Generate APT metadata
        run: |
          cd root-repo

          dpkg-scanpackages -m pool > dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-amd64/Packages

          apt-ftparchive release dists/stable > dists/stable/Release

          sed -i '1iOrigin: HeadPose\nLabel: HeadPose' dists/stable/Release

          cd ..

      # ✅ Archive ENTIRE repo (IMPORTANT)
      - name: Archive APT repository
        run: |
          tar -czf $REPO_ARCHIVE root-repo
          ls -lh $REPO_ARCHIVE

      # ✅ Upload GitHub Pages artifact
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: root-repo

      - name: Verify artifacts
        run: |
          ls -lh
          ls -lh build
          ls -lh $REPO_ARCHIVE

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Headpose v${{ env.VERSION }}
          files: |
            build/headpose
            ${{ env.REPO_ARCHIVE }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    