name: Build and Publish Headpose

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      VERSION: "1.0.0"
      PKG_NAME: headpose

    steps:

      # ✅ Checkout
      - name: Checkout source
        uses: actions/checkout@v4


      # ✅ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"


      # ✅ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka


      # ✅ Build Binary
      - name: Build Nuitka binary
        run: |
          mkdir -p build

          nuitka \
            --onefile \
            --follow-imports \
            --lto=no \
            --python-flag=no_docstrings \
            --static-libpython=no \
            --include-data-dir=src/weights=weights \
            --output-dir=build \
            --output-filename=headpose \
            src/main.py

          chmod 755 build/headpose
          file build/headpose


      # ✅ Build DEB
      - name: Build DEB package
        run: |
          PKG_DIR=${PKG_NAME}_${VERSION}_amd64

          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin

          cp build/headpose ${PKG_DIR}/usr/bin/headpose
          chmod 755 ${PKG_DIR}/usr/bin/headpose

          cat > ${PKG_DIR}/DEBIAN/control <<EOF
          Package: headpose
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Sayantan Dey <iamsayantandey007@gmail.com>
          Description: Head Pose Estimation Tool
           Head pose estimation using SCRFD + Pose Estimator.
          EOF

          dpkg-deb --build ${PKG_DIR}


      # ✅ Install repo tools
      - name: Install APT repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils


      # ✅ Checkout gh-pages branch (to KEEP old packages)
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo
        continue-on-error: true


      # ✅ Create repo if first run
      - name: Prepare repository folder
        run: |
          if [ ! -d repo ]; then
            mkdir repo
          fi

          mkdir -p repo/pool/main/h/headpose
          mkdir -p repo/dists/stable/main/binary-amd64


      # ✅ Move new package into pool
      - name: Add package to pool
        run: |
          mv headpose_${VERSION}_amd64.deb repo/pool/main/h/headpose/


      # ✅ Generate Packages + Release (NO GPG)
      - name: Generate APT metadata
        run: |
          cd repo

          dpkg-scanpackages -m pool > dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-amd64/Packages

          apt-ftparchive release dists/stable > dists/stable/Release

          sed -i '1iOrigin: HeadPose\nLabel: HeadPose' dists/stable/Release


      # ✅ Upload GitHub Pages artifact
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: repo


  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
